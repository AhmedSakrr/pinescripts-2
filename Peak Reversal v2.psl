// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © Zettt
// 2021

//@version=4
study("Peak Reversal v2", shorttitle="Peak Reversal v2", overlay=true)

showOnlyFirstSignal = true
keltnerEMAlength = input(title="Keltner Channel EMA Length", defval=21, minval=1, type=input.integer)
keltnerMultiplier = input(title="Keltner Bands Multiplier", defval=2.25, minval=1, type=input.float)
maximumPeakMultiplier = input(title="Keltner Maximum Multiplier", defval=3.375, minval=1, type=input.float)

// define Keltner bands 
atrlength = 14
upKeltnerBand = ( ema(close, keltnerEMAlength) + (rma(tr(true), atrlength) * keltnerMultiplier) )
downKeltnerBand = ( ema(close, keltnerEMAlength) - (rma(tr(true), atrlength) * keltnerMultiplier) )

upMaximumBand = ( ema(close, keltnerEMAlength) + (rma(tr(true), atrlength) * maximumPeakMultiplier) )
downMaximumBand = ( ema(close, keltnerEMAlength) - (rma(tr(true), atrlength) * maximumPeakMultiplier) )

// plot bands
plot(upKeltnerBand, title="Keltner Channel Upper Band", color=#991515)
plot(downKeltnerBand, title="Keltner Channel Lower Band", color=#991515)
plot(upMaximumBand, title="Keltner Extreme Upper Band", color=#991515, display=display.none)
plot(downMaximumBand, title="Keltner Extreme Lower Band", color=#991515, display=display.none)

// plot bar colors depending on how many bars are outside the band
// outside the upper band
firstFreeBarUp = high <= upKeltnerBand and close <= upKeltnerBand
numFreeBarsUp = barssince(firstFreeBarUp)

color colorBarUp = na

if numFreeBarsUp > 5
    colorBarUp := #b71c1c
else if numFreeBarsUp > 2
    colorBarUp := #ef5350
else if numFreeBarsUp > 0
    colorBarUp := #ef9a9a
else
    colorBarUp := na
    
barcolor(colorBarUp, title="Up Deviations")
// color=#81c784

// outside lower band
firstFreeBarDown = low >= downKeltnerBand and close >= downKeltnerBand
numFreeBarsDown = barssince(firstFreeBarDown)

color colorBarDown = na

if numFreeBarsDown > 5
    colorBarDown := #1b5e20
else if numFreeBarsDown > 2
    colorBarDown := #66bb6a
else if numFreeBarsDown > 0
    colorBarDown := #a5d6a7
else
    colorBarDown := na
    
barcolor(colorBarDown, title="Down Deviations")

// Plot breakouts
longBreakout = high >= upKeltnerBand // and open <= upKeltnerBand
shortBreakout = close <= downKeltnerBand // and open >= downKeltnerBand


showLongBreakout = showOnlyFirstSignal ? longBreakout and not longBreakout[1] : longBreakout
showShortBreakout = showOnlyFirstSignal ? shortBreakout and not shortBreakout[1] : shortBreakout

plotshape(showLongBreakout, title="Breakout", style=shape.triangledown, size=size.tiny, color=#e57373, transp=60, location=location.abovebar)
plotshape(showShortBreakout, title="Breakdown", style=shape.triangleup, size=size.tiny, color=#81c784, transp=60, location=location.belowbar)

// Plot maximum breakouts
longMaximumBreakout = high >= upMaximumBand // and open <= upMaximumBand
shortMaximumBreakout = low <= downMaximumBand // and open >= downMaximumBand


showLongMaximumBreakout = showOnlyFirstSignal ? longMaximumBreakout and not longMaximumBreakout[1] : longMaximumBreakout
showShortMaximumBreakout = showOnlyFirstSignal ? shortMaximumBreakout and not shortMaximumBreakout[1] : shortMaximumBreakout

plotshape(showLongMaximumBreakout, title="Breakout", style=shape.triangledown, size=size.tiny, color=#e57373, transp=20, location=location.abovebar)//, display=display.none)
plotshape(showShortMaximumBreakout, title="Breakdown", style=shape.triangleup, size=size.tiny, color=#81c784, transp=20, location=location.belowbar)//, display=display.none)

    

// Plot free bars breakouts
longFreeBar = low >= upKeltnerBand
shortFreeBar = high <= downKeltnerBand

// plotshape(showFreeBars ? longFreeBar : na, title="Free Bar Up", style=shape.triangledown, size=size.tiny, color=#e57373, transp=10, location=location.abovebar)//, display=display.none)
// plotshape(showFreeBars ? shortFreeBar : na, title="Free Bar Down", style=shape.triangleup, size=size.tiny, color=#81c784, transp=10, location=location.belowbar)//, display=display.none)
plotchar(showFreeBars ? longFreeBar : na, title="Free Bar Up", char="★", size=size.tiny, color=#e57373, transp=10, location=location.abovebar)//, display=display.none)
plotchar(showFreeBars ? shortFreeBar : na, title="Free Bar Down", char="★", size=size.tiny, color=#81c784, transp=10, location=location.belowbar)//, display=display.none)
